<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.system.mapper.SysUserMapper">

	<!-- 根据用户名查询 -->
	<select id="getUserByName" resultType="org.jeecg.modules.system.entity.SysUser">
		select * from  sys_user  where username = #{username} and del_flag = 0
	</select>

	<!-- 根据部门Id查询 -->
	<select id="getUserByDepId" resultType="org.jeecg.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0 and id in (select user_id from sys_user_depart where dep_id=#{departId})
		<if test="username!=null and username!=''">
			and username = #{username}
		</if>
	</select>

	<!-- 查询用户的所属部门名称信息 -->
	<select id="getDepNamesByUserIds" resultType="org.jeecg.modules.system.vo.SysUserDepVo">
		select d.depart_name,ud.user_id from sys_user_depart ud,sys_depart d where d.id = ud.dep_id and ud.user_id in
		<foreach collection="userIds" index="index" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</select>

	<!-- 通过多个部门IDS，查询部门下的用户信息 -->
	<select id="getUserByDepIds" resultType="org.jeecg.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0
		<if test="departIds!=null  and departIds.size()>0">
			and id in (select user_id from sys_user_depart where dep_id in
			<foreach collection="departIds" index="index" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			)
		</if>
		<if test="username!=null and username!=''">
			and username = #{username}
		</if>
	</select>

	<!-- 根据角色Id查询 -->
	<select id="getUserByRoleId" resultType="org.jeecg.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0 and id in (select user_id from sys_user_role where role_id=#{roleId})
		<if test="username!=null and username!=''">
			and username = #{username}
		</if>
	</select>
	
	<!--  修改用户部门code -->
	<update id="updateUserDepart">
		UPDATE sys_user SET org_code = #{orgCode} where username = #{username}
	</update>

	<!-- 根据手机号查询 -->
	<select id="getUserByPhone"  resultType="org.jeecg.modules.system.entity.SysUser">
		select * from  sys_user  where phone = #{phone} and del_flag = 0
	</select>
	
	<!-- 根据邮箱查询用户信息 -->
	<select id="getUserByEmail" resultType="org.jeecg.modules.system.entity.SysUser">
	select * from  sys_user  where email = #{email} and del_flag = 0
	</select>

	<!-- SQL片段：getUserByOrgCode 的 FROM 和 WHERE 部分 -->
	<sql id="getUserByOrgCodeFromSql">
		FROM
		sys_depart
		INNER JOIN sys_user_depart ON sys_user_depart.dep_id = sys_depart.id
		INNER JOIN sys_user ON sys_user.id = sys_user_depart.user_id
		WHERE
		<if test="orgCode == null">
			<bind name="bindOrgCode" value="'%'"/>
		</if>
		<if test="orgCode != null">
			<bind name="bindOrgCode" value="orgCode+'%'"/>
		</if>
		sys_user.del_flag = 0 AND sys_depart.org_code LIKE #{bindOrgCode}

		<if test="userParams != null">
			<if test="userParams.realname != null and userParams.realname != ''">
				AND sys_user.realname LIKE concat(concat('%',#{userParams.realname}),'%')
			</if>
			<if test="userParams.workNo != null and userParams.workNo != ''">
				AND sys_user.work_no LIKE concat(concat('%',#{userParams.workNo}),'%')
			</if>
		</if>
	</sql>

	<!-- 根据 orgCode 查询用户，包括子部门下的用户 -->
	<select id="getUserByOrgCode" resultType="org.jeecg.modules.system.model.SysUserSysDepartModel">
		SELECT
			sys_user.id AS id,
			sys_user.realname AS realname,
			sys_user.avatar AS avatar,
			sys_user.sex AS sex,
			sys_user.birthday AS birthday,
			sys_user.work_no AS workNo,
			sys_user.post AS post,
			sys_user.telephone AS telephone,
			sys_user.email AS email,
			sys_user.phone AS phone,
			sys_depart.id AS departId,
			sys_depart.depart_name AS departName
		<include refid="getUserByOrgCodeFromSql"/>
		ORDER BY
			sys_depart.org_code ASC
	</select>

	<!-- 查询 getUserByOrgCode 的总数-->
	<select id="getUserByOrgCodeTotal" resultType="java.lang.Integer">
		SELECT COUNT(1) <include refid="getUserByOrgCodeFromSql"/>
	</select>

	<!-- 批量删除角色的与用户关系-->
	<update id="deleteBathRoleUserRelation">
		delete from sys_user_role
		where role_id in
		<foreach item="id" collection="roleIdArray" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>
	<!-- 批量删除角色的与权限关系-->
	<update id="deleteBathRolePermissionRelation">
		delete from sys_role_permission
		where role_id in
		<foreach item="id" collection="roleIdArray" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>

	<!-- 查询被逻辑删除的用户 -->
	<select id="selectLogicDeleted" resultType="org.jeecg.modules.system.entity.SysUser">
		SELECT * FROM sys_user ${ew.customSqlSegment}
	</select>

	<!-- 更新被逻辑删除的用户 -->
	<update id="revertLogicDeleted">
		UPDATE
			sys_user
		SET
			del_flag = 0,
			update_by = #{entity.updateBy},
			update_time = #{entity.updateTime}
		WHERE
			del_flag = 1
			AND id IN
			<foreach collection="userIds" item="userId" open="(" close=")" separator="," >
				#{userId}
			</foreach>
	</update>

	<!-- 彻底删除被逻辑删除的用户 -->
	<delete id="deleteLogicDeleted">
		DELETE FROM sys_user WHERE del_flag = 1 AND id IN
		<foreach collection="userIds" item="userId" open="(" close=")" separator="," >
			#{userId}
		</foreach>
	</delete>

	<!-- 更新空字符串为null -->
	<update id="updateNullByEmptyString">
		UPDATE sys_user
		<if test="fieldName == 'email'">
			SET email = NULL WHERE email = ''
		</if>
		<if test="fieldName == 'phone'">
			SET phone = NULL WHERE phone = ''
		</if>
	</update>

	<!-- 通过多个部门IDS，查询部门下的用户信息 -->
	<select id="queryByDepIds" resultType="org.jeecg.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0
		<if test="departIds!=null  and departIds.size()>0">
			and id in (select user_id from sys_user_depart where dep_id in
			<foreach collection="departIds" index="index" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			)
		</if>
		<if test="username!=null and username!=''">
			and username != #{username}
		</if>
	</select>

	<!--根据sysUserId 查询 返回角色roleCode-->
	<select id="getUserRoleCode" resultType="string">
		SELECT  sr.role_code FROM  (SELECT su.*,sur.id AS surId,sur.`role_id` AS roleId FROM sys_user su LEFT JOIN  sys_user_role sur ON  su.id = sur.user_id) suAndSur LEFT JOIN  sys_role sr ON suAndSur.roleId = sr.id
		WHERE suAndSur.del_flag = 0 AND suAndSur.status = 1
		<if test="sysUserId!=null and sysUserId!=''">
			AND suAndSur.id =  #{sysUserId}
		</if>
	</select>

	<select id="findAll" resultType="org.jeecg.modules.system.vo.SysWorkbenchVO">
		SELECT
			su.id,
			su.`avatar`,
			-- 头像
			su.`realname`,
			-- 联系人
			(SELECT
				 GROUP_CONCAT(sr.`role_name`)
			 FROM
				 sys_user_role sur
					 LEFT JOIN sys_role sr
							   ON sur.`role_id` = sr.`id`
			 WHERE sur.`user_id` = su.id) AS roleName,
			-- 角色
			IF(
					su.`org_code` = NULL,
					'',
					(SELECT
						 sd.`depart_name`
					 FROM
						 sys_depart sd
					 WHERE sd.`del_flag` = 0
					   AND sd.`org_code` = su.`org_code`)

				) AS NAME,
			-- 公司名称
			(
				CASE
					su.`status`
					WHEN 1
						THEN '正常'
					WHEN 2
						THEN '冻结'
					ELSE '异常'
					END
				) AS statusName,
			-- 状态
			(
					(SELECT
						 COUNT(1)
					 FROM
						 order_list ol
					 WHERE ol.`del_flag` = 0
					   AND ol.`status` = 5) +
					(SELECT
						 COUNT(1)
					 FROM
						 order_store_list osl
					 WHERE osl.`del_flag` = 0
					   AND osl.`status` = 5)
				) AS orderSum,
			-- 有效订单
			(
					(SELECT
						 SUM(ol.`actual_payment`)
					 FROM
						 order_list ol
					 WHERE ol.`del_flag` = 0
					   AND ol.`status` = 5) +
					(SELECT
						 SUM(sp.`money`)
					 FROM
						 store_payment sp
					 WHERE sp.`del_flag` = 0
					   AND sp.`pay_status` = 1) +
					(SELECT
						 SUM(mgbr.`price`)
					 FROM
						 marketing_gift_bag_record mgbr
					 WHERE mgbr.`del_flag` = 0
					   AND mgbr.`pay_status` = 1
					   AND mgbr.`back_status` = 1) +
					(SELECT
						 SUM(osl.`actual_payment`)
					 FROM
						 order_store_list osl
					 WHERE osl.`del_flag` = 0
					   AND osl.`status` = 5)
				) AS earnings,
			-- 累计收入
			(SELECT
				 COUNT(1)
			 FROM
				 member_list ml
			 WHERE ml.`del_flag` = 0) AS memberSum,
			-- 累计会员
			(SELECT
				 SUM(mwp.`bargain_payments`)
			 FROM
				 marketing_welfare_payments mwp
			 WHERE mwp.`del_flag` = 0
			) AS welfareSum,
			-- 已送福利金
			(SELECT
				 COUNT(1)
			 FROM
				 store_manage sm
			 WHERE sm.`del_flag` = 0
			   AND sm.`attestation_status` in(1,2)) AS storeSum,
			-- 已认证店铺
			(SELECT
				 COUNT(1)
			 FROM
				 provider_manage pm
			 WHERE pm.`del_flag` = 0) AS providerSum,
			-- 供应商
			(
					(SELECT
						 COUNT(1)
					 FROM
						 order_list ol
					 WHERE ol.`del_flag` = 0
					   AND ol.`status` = 1) +
					(SELECT
						 COUNT(1)
					 FROM
						 order_store_list osl
					 WHERE osl.`del_flag` = 0
					   AND osl.`status` = 1)
				) AS waitDeliverGoods,
			-- 待发货订单
			(SELECT
				 COUNT(1)
			 FROM
				 good_list gl
			 WHERE gl.`del_flag` = 0
			   AND gl.`status` = 1
			   AND gl.`frame_status` = 1
			   AND gl.`audit_status` = 2) AS forGoods,
			-- 在售商品
			(SELECT
				 COUNT(1)
			 FROM
				 marketing_discount_coupon mdc
			 WHERE mdc.`del_flag` = 0
			) AS byGetDiscount,
			-- 已被领取优惠券
			(SELECT
				 COUNT(1)
			 FROM
				 marketing_discount_coupon mdc
			 WHERE mdc.`del_flag` = 0
			   AND mdc.`status` = 2) AS byUseDiscount
			-- 已被使用优惠券
		FROM
			sys_user su
				LEFT JOIN sys_user_role sur
						  ON su.`id` = sur.`user_id`
				LEFT JOIN sys_role sr
						  ON sur.`role_id` = sr.`id`
		WHERE su.`del_flag` = 0
		  AND su.`id` = #{userId}
	</select>

	<!-- 根据角色名称查询 -->
	<select id="getUserByRoleName" resultType="org.jeecg.modules.system.dto.SysUserDTO" >
		SELECT
			id AS id,
			realname AS realname
		FROM
			sys_user
		WHERE del_flag = '0'
		  AND id IN
			  (SELECT
				   user_id
			   FROM
				   sys_user_role
			   WHERE role_id IN
					 (SELECT
						  id
					  FROM
						  sys_role
					  WHERE role_name = #{roleName}))
	</select>

	<select id="getEarningList" resultType="org.jeecg.modules.system.vo.SysWorkbenchVO">
		SELECT
			SUM(a.totalprice) AS totalprice,
			a.myDate
		FROM
			(SELECT
				 SUM(osl.`actual_payment`) AS totalprice,
				 DATE_FORMAT(osl.`delivery_time`, '%Y-%m-%d') AS myDate
			 FROM
				 order_store_list osl
			 WHERE osl.`del_flag` = 0
			   AND osl.`status` = 5
			 GROUP BY myDate
			 UNION
			 SELECT
				 SUM(mgbr.`price`) AS totalprice,
				 DATE_FORMAT(mgbr.`pay_time`, '%Y-%m-%d') AS myDate
			 FROM
				 marketing_gift_bag_record mgbr
			 WHERE mgbr.`del_flag` = 0
			   AND mgbr.`pay_status` = 1
			   AND mgbr.`back_status` = 1
			 GROUP BY myDate
			 UNION
			 SELECT
				 SUM(sp.`money`) AS totalprice,
				 DATE_FORMAT(sp.`pay_time`, '%Y-%m-%d') AS myDate
			 FROM
				 store_payment sp
			 WHERE sp.`del_flag` = 0
			   AND sp.`pay_status` = 1
			 GROUP BY myDate
			 UNION
			 SELECT
				 SUM(ol.`actual_payment`) AS totalprice,
				 DATE_FORMAT(ol.`delivery_time`, '%Y-%m-%d') AS myDate
			 FROM
				 order_list ol
			 WHERE ol.`del_flag` = 0
			   AND ol.`status` = 5
			 GROUP BY myDate) a
		WHERE a.myDate <![CDATA[>=]]> #{sysWorkbenchVO.earningTime_begin}
		  AND a.myDate <![CDATA[<=]]> #{sysWorkbenchVO.earningTime_end}
		GROUP BY a.myDate
		ORDER BY a.myDate DESC
	</select>

	<select id="totalSum" resultType="org.jeecg.modules.system.vo.SysWorkbenchVO">
		SELECT
			(
					(SELECT
						 SUM(mwp.`bargain_payments`)
					 FROM
						 marketing_welfare_payments mwp
					 WHERE mwp.`del_flag` = 0
					   AND mwp.`is_platform` = 0
					   AND mwp.`we_type` = 0) +
					(SELECT
						 SUM(mwp.`bargain_payments`)
					 FROM
						 marketing_welfare_payments mwp
					 WHERE mwp.`del_flag` = 0
					   AND mwp.`is_platform` = 1)
				) AS earnings
		FROM
			sys_user su
		WHERE su.`del_flag` = 0
		  AND su.`id` = 'a75d45a015c44384a04449ee80dc3503'
	</select>
</mapper>